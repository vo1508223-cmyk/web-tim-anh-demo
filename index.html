<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Web t√¨m ·∫£nh s·ª± ki·ªán</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-bold text-center mb-6">üì∏ Web t√¨m ·∫£nh s·ª± ki·ªán</h1>

    <!-- Tabs -->
    <div class="flex justify-center space-x-6 mb-6">
      <button id="adminTab" class="px-4 py-2 bg-blue-500 text-white rounded">Qu·∫£n l√Ω s·ª± ki·ªán</button>
      <button id="searchTab" class="px-4 py-2 bg-gray-300 rounded">T√¨m ·∫£nh c·ªßa b·∫°n</button>
    </div>

    <!-- Admin Section -->
    <div id="adminSection">
      <h2 class="text-xl font-semibold mb-2">T·∫°o s·ª± ki·ªán m·ªõi</h2>
      <form id="eventForm" class="space-y-3">
        <input type="text" id="eventId" placeholder="ID s·ª± ki·ªán" required
               class="w-full border p-2 rounded"/>
        <input type="file" id="eventFiles" multiple required
               class="w-full border p-2 rounded"/>
        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded">T·∫°o s·ª± ki·ªán</button>
      </form>
      <p id="eventMsg" class="mt-3 text-green-600"></p>
    </div>

    <!-- Search Section -->
    <div id="searchSection" class="hidden">
      <h2 class="text-xl font-semibold mb-2">T√¨m ·∫£nh c·ªßa b·∫°n</h2>
      <form id="searchForm" class="space-y-3">
        <select id="eventSelect" class="w-full border p-2 rounded"></select>
        <input type="file" id="queryFile" required class="w-full border p-2 rounded"/>
        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded">T√¨m ·∫£nh</button>
      </form>
      <div id="results" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4"></div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.origin;

    // Tab switching
    const adminTab = document.getElementById("adminTab");
    const searchTab = document.getElementById("searchTab");
    const adminSection = document.getElementById("adminSection");
    const searchSection = document.getElementById("searchSection");

    adminTab.addEventListener("click", () => {
      adminSection.classList.remove("hidden");
      searchSection.classList.add("hidden");
      adminTab.classList.add("bg-blue-500","text-white");
      searchTab.classList.remove("bg-blue-500","text-white");
      searchTab.classList.add("bg-gray-300");
    });

    searchTab.addEventListener("click", () => {
      searchSection.classList.remove("hidden");
      adminSection.classList.add("hidden");
      searchTab.classList.add("bg-blue-500","text-white");
      adminTab.classList.remove("bg-blue-500","text-white");
      adminTab.classList.add("bg-gray-300");
      loadEvents();
    });

    // Admin: t·∫°o s·ª± ki·ªán
    document.getElementById("eventForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const eventId = document.getElementById("eventId").value;
      const files = document.getElementById("eventFiles").files;
      if (!eventId || files.length === 0) return alert("Nh·∫≠p ID v√† ch·ªçn ·∫£nh!");

      const fd = new FormData();
      fd.append("event_id", eventId);
      for (let f of files) {
        fd.append("files", f);
      }

      const resp = await fetch(`${API_BASE_URL}/create_event/`, {
        method: "POST",
        body: fd
      });
      const data = await resp.json();
      document.getElementById("eventMsg").innerText = JSON.stringify(data, null, 2);
    });

    // Search: t·∫£i danh s√°ch s·ª± ki·ªán
    async function loadEvents() {
      const resp = await fetch(`${API_BASE_URL}/events/`);
      const data = await resp.json();
      const select = document.getElementById("eventSelect");
      select.innerHTML = "";
      data.events.forEach(ev => {
        const opt = document.createElement("option");
        opt.value = ev;
        opt.innerText = ev;
        select.appendChild(opt);
      });
    }

    // Search: t√¨m ·∫£nh
    document.getElementById("searchForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const eventId = document.getElementById("eventSelect").value;
      const file = document.getElementById("queryFile").files[0];
      if (!eventId || !file) return alert("Ch·ªçn s·ª± ki·ªán v√† ·∫£nh!");

      const fd = new FormData();
      fd.append("event_id", eventId);
      fd.append("file", file);

      const resp = await fetch(`${API_BASE_URL}/search/`, {
        method: "POST",
        body: fd
      });
      const data = await resp.json();
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (data.results) {
        data.results.forEach(url => {
          const img = document.createElement("img");
          img.src = url;
          img.className = "w-full h-auto border rounded";
          resultsDiv.appendChild(img);
        });
      } else {
        resultsDiv.innerHTML = `<p class="text-red-600">${data.error}</p>`;
      }
    });
  </script>
</body>
</html>
